{% extends "base.html" %}

{% block title %}Upload Dataset - NLQ Assistant{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-xl shadow-md border border-slate-200 p-8">
        <div class="text-center mb-8">
            <i class="fas fa-cloud-upload-alt text-5xl text-blue-600 mb-4"></i>
            <h1 class="text-3xl font-bold text-slate-900">Upload Dataset</h1>
            <p class="text-slate-600 mt-2">Upload a CSV or Excel file to start querying</p>
        </div>

        <form method="post" action="{% url 'process_query' %}" enctype="multipart/form-data" class="space-y-6" id="upload-form">
            {% csrf_token %}
            
            <div id="error-message" style="display: none;" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
            </div>
            
            <div id="loading-message" style="display: none;" class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Uploading and processing your file...</span>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-3">Select File</label>
                <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition cursor-pointer bg-blue-50" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-file-csv text-5xl text-blue-600 mb-3 block"></i>
                    <p class="text-slate-700 font-semibold text-lg">Click to select file</p>
                    <p class="text-sm text-slate-600 mt-1">or drag and drop your file here</p>
                    <p class="text-xs text-slate-500 mt-3">Supported: CSV, XLS, XLSX (Max 50MB)</p>
                </div>
                <input 
                    id="file-input"
                    type="file" 
                    name="file" 
                    accept=".csv,.xls,.xlsx"
                    required
                    class="hidden"
                    onchange="updateFileName(this)"
                >
                <p id="file-name" class="text-sm text-blue-600 mt-3 text-center font-medium">No file selected</p>
            </div>

            <button 
                type="submit"
                id="submit-btn"
                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white py-3 rounded-lg font-bold transition shadow-md hover:shadow-lg"
            >
                <i class="fas fa-upload mr-2"></i> Upload & Process
            </button>

            <div class="text-center">
                <a href="{% url 'query_interface' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                    ← Back to Chat
                </a>
            </div>
        </form>

        <!-- Features -->
        <div class="mt-8 pt-6 border-t border-slate-200">
            <h3 class="text-sm font-semibold text-slate-700 mb-4">What happens after upload?</h3>
            <div class="space-y-2 text-sm text-slate-600">
                <div class="flex items-start gap-3">
                    <i class="fas fa-check text-green-600 mt-0.5 flex-shrink-0"></i>
                    <span>Your file is automatically analyzed and indexed</span>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-check text-green-600 mt-0.5 flex-shrink-0"></i>
                    <span>A database table is created with proper column detection</span>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-check text-green-600 mt-0.5 flex-shrink-0"></i>
                    <span>You can immediately start asking questions about your data</span>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-check text-green-600 mt-0.5 flex-shrink-0"></i>
                    <span>Your data is stored securely on your local server</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Example Data -->
    <div class="mt-8 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl p-6 border border-slate-200">
        <h3 class="font-bold text-slate-900 mb-3">Example Questions You Can Ask</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="flex items-start gap-3">
                <i class="fas fa-comment text-blue-600 flex-shrink-0 mt-0.5"></i>
                <span class="text-sm text-slate-700">"Show me all records"</span>
            </div>
            <div class="flex items-start gap-3">
                <i class="fas fa-comment text-blue-600 flex-shrink-0 mt-0.5"></i>
                <span class="text-sm text-slate-700">"Count records by city"</span>
            </div>
            <div class="flex items-start gap-3">
                <i class="fas fa-comment text-blue-600 flex-shrink-0 mt-0.5"></i>
                <span class="text-sm text-slate-700">"Find top 10 entries"</span>
            </div>
            <div class="flex items-start gap-3">
                <i class="fas fa-comment text-blue-600 flex-shrink-0 mt-0.5"></i>
                <span class="text-sm text-slate-700">"Filter by specific criteria"</span>
            </div>
        </div>
    </div>
</div>

<script>
function updateFileName(input) {
    const fileName = input.files[0]?.name || 'No file selected';
    const fileSize = input.files[0]?.size || 0;
    
    if (fileSize > 0) {
        const sizeMB = (fileSize / (1024 * 1024)).toFixed(2);
        document.getElementById('file-name').textContent = `✓ ${fileName} (${sizeMB} MB)`;
    } else {
        document.getElementById('file-name').textContent = `✓ ${fileName}`;
    }
}

// Form submission handling
document.getElementById('upload-form').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('file-input');
    const errorMsg = document.getElementById('error-message');
    const loadingMsg = document.getElementById('loading-message');
    const submitBtn = document.getElementById('submit-btn');
    
    // Hide previous error messages
    errorMsg.style.display = 'none';
    errorMsg.textContent = '';
    
    // Validate file is selected
    if (!fileInput.files || fileInput.files.length === 0) {
        e.preventDefault();
        errorMsg.textContent = '❌ Please select a file before uploading.';
        errorMsg.style.display = 'block';
        return false;
    }
    
    const file = fileInput.files[0];
    
    // Validate file size (50MB limit)
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
        e.preventDefault();
        errorMsg.textContent = `❌ File is too large (${(file.size / (1024 * 1024)).toFixed(2)} MB). Maximum allowed size is 50 MB.`;
        errorMsg.style.display = 'block';
        return false;
    }
    
    // Validate file type
    const allowedTypes = ['.csv', '.xls', '.xlsx'];
    const fileName = file.name.toLowerCase();
    const hasValidExtension = allowedTypes.some(ext => fileName.endsWith(ext));
    
    if (!hasValidExtension) {
        e.preventDefault();
        errorMsg.textContent = `❌ Invalid file type. Allowed formats: CSV, XLS, XLSX`;
        errorMsg.style.display = 'block';
        return false;
    }
    
    // Show loading message and disable button
    loadingMsg.style.display = 'flex';
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
});

// Drag and drop functionality
const fileInput = document.getElementById('file-input');
const dropZone = document.querySelector('[onclick="document.getElementById(\'file-input\').click()"]');

if (dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('border-blue-500');
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-blue-500');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        // Validate files
        if (files.length > 0) {
            fileInput.files = files;
            updateFileName(fileInput);
        }
    }
}
</script>
{% endblock %}
